<!DOCTYPE html>
<html>
	<head>
		<title>Cooperative Coder</title>
		<link rel="stylesheet" type="text/css" href="css/css/bootstrap.min.css">
		<link rel="stylesheet" type="text/css" href="style.css">
		<link rel="stylesheet" type="text/css" href="prism.css">

	</head>
	<body>
		<div id='wrap'>
		<div class='container'>
		<header class='page-header'>
			<h1>The Cooperative Code Challenge</h1>
			<p>
				Veggies sunt bona vobis, proinde vos postulo esse magis spinach watercress plantain water spinach okra broccoli bok choy corn pea lentil black-eyed pea garlic.
			</p>
			<p>
				Beetroot corn cabbage melon scallion burdock chickweed turnip groundnut fennel tigernut garlic swiss chard avocado squash mustard amaranth. Gram dandelion pea sprouts komatsuna maize amaranth bunya nuts plantain j√≠cama water chestnut sea lettuce quandong rock melon courgette black-eyed pea kale. Broccoli rabe beet greens napa cabbage scallion fava bean chard celtuce lotus root caulie arugula beetroot bok choy zucchini kohlrabi garbanzo leek bunya nuts brussels sprout.
			</p>
		</header>

		<section>
			<h2>The result</h2>
			<div id="result"></div>
		</section>
		
		<section>
			<div class='col-xs-6'>
				<h2>Player One</h2>
				<div id="question_1"></div>
				<button id="ready_1" type='button' class='btn btn-deafult'>Ready</button>
				<code class="language-js"><textarea class='form-control' rows='4' id="input_1"></textarea></code>
				<div id="errors_1"></div>
			</div>
			<div class='col-xs-6'>
				<h2>Player Two</h2>
				<div id="question_2"></div>
				<button id="ready_2" type='button' class='btn btn-default'>Ready</button>
				<code class="language-js"><textarea class='form-control' rows='4' id="input_2"></textarea></code>
				<div id="errors_2"></div>
			</div>
		</section>
		</div> <!--wrap -->
		
	</div> <!--container -->
	<div id='footer'>
			<div class='container'></div>
		</div>
	</body>
	<script src="http://cdn.pubnub.com/pubnub.min.js"></script>
	<script src="./prism.js" type="text/javascript" charset="utf-8"></script>
		<script>
			(function(){

				var questions = [
					{ 	question_1 : "Write a function to subtract one from a number", 
					 	placeholder_1 : "function subtract(num){}",
					 	question_2 : "Write a function to multiply a number by 2",
					 	placeholder_2 : "function multiply(num){}", 
					 	validate : function(){
					 		var inputs = [1,2,3,4,5,6]
					 		var outputs = []
					 		for (var i = inputs.length - 1; i >= 0; i--) {
					 			outputs.push( multiply(subtract(inputs[i])) );						 			
					 		}
					 		valid = true;
					 		for (var i = outputs.length - 1; i >= 0; i--) {
					 			valid = valid && outputs[i] == (inputs[i]-1)*2;
					 		}
					 		return valid;
					 	}
					 },
					 { 	question_1 : "Write a function to add one from a number", 
					 	placeholder_1 : "function add(num){}",
					 	question_2 : "Write a function to multiply a number by 4",
					 	placeholder_2 : "function multiply(num){}", 
					 	validate : function(){
					 		var inputs = [1,2,3,4,5,6]
					 		var outputs = []
					 		for (var i = inputs.length - 1; i >= 0; i--) {
					 			outputs.push( multiply(add(inputs[i])) );						 			
					 		}
					 		valid = true;
					 		for (var i = outputs.length - 1; i >= 0; i--) {
					 			valid = valid && outputs[i] == (inputs[i]+1)*4;
					 		}
					 		return valid;
					 	}
					 }
				];

				var id = Math.random().toString(36).substring(7);
				var player = 0;
				var channel = 'colabcode';
				var question = Math.floor(Math.random() * (questions.length-1)) ;
				var ready_1 = false;
				var ready_2 = false;

				function setQuestion(q){
					question = q;
					document.getElementById('question_1').textContent = questions[question].question_1;
					document.getElementById('question_2').textContent = questions[question].question_2;
					document.getElementById('input_1').value = questions[question].placeholder_1;
					document.getElementById('input_2').value = questions[question].placeholder_2;
				}


				document.getElementById('ready_1').onclick = function(){
					ready_1 = true;
					obj = page_message();
					obj.sync = true;
					pubnub.publish({
						channel : channel,
						message : obj
					});
				};
				document.getElementById('ready_2').onclick = function(){
					ready_2 = true;
					pubnub.publish({
						channel : channel,
						message : page_message()
					});
					obj = page_message();
					obj.sync = true;
					pubnub.publish({
						channel : channel,
						message : obj
					});
				};
			
				var pubnub = PUBNUB.init({
		     		publish_key: 'demo',
	     			subscribe_key: 'demo',
	     			uuid: id
	 			});	
	 			pubnub.here_now({
	 				channel : channel,
	 				callback : function(m){
	 					console.log(m);
	 					if(m.occupancy % 2 == 0){
	 						player = 1;
	 						document.getElementById('input_2').setAttribute('readonly','readonly');
	 					}else{
	 						player = 2;
	 						document.getElementById('input_1').setAttribute('readonly','readonly');
	 					}
	 				}
	 			});
				pubnub.subscribe({
					channel : channel,
					message : function(text){
						console.log(text);
					},
					callback : function(obj) { 
						console.log(obj);
						if(obj.sender == 1){
							document.getElementById('input_1').value = obj.p1;
							ready_1 = obj.ready_1;
						}
						if(obj.sender == 2){
							document.getElementById('input_2').value = obj.p2;
							ready_2 = obj.ready_2;
						}
						if(obj.sync){
							console.log("syncing question");
							setQuestion(obj.question);
						}
					},
					presence : function(obj){
						/* Notify Users that they have a partner here */

					}
				});
				function page_message (){
					return {ready_1 : ready_1, ready_2 : ready_2, question : question, sender: player, p1 : document.getElementById('input_1').value, p2 : document.getElementById('input_2').value}
				}
				pubnub.bind( 'keyup', document.getElementById('input_1'), function(e) {
					(e.keyCode || e.charCode) === 13 && pubnub.publish({
						channel : channel, 
						message : page_message()
					});	
				} );
				pubnub.bind( 'keyup', document.getElementById('input_2'), function(e) {
					(e.keyCode || e.charCode) === 13 && pubnub.publish({
						channel : channel, 
						message : page_message()
					});	
				} );
				/* Periodically refresh boxes */
				var refresh = setInterval(function(){
					console.log('auto refresh');
					pubnub.publish({
						channel : channel,
						message : page_message()
					});
				},10000);

			})();
	</script>

</html>